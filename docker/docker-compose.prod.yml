# Docker Compose for production deployment on EC2
# Uses pre-built images from GitHub Container Registry (GHCR)
# Caddy reverse proxy provides automatic HTTPS via Let's Encrypt

name: quant-finance

services:
  caddy:
    image: caddy:2-alpine
    restart: unless-stopped
    mem_limit: 64m
    memswap_limit: 64m
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - quant-finance
      - options
      - fixed-income
      - portfolio-management

  quant-finance:
    image: ghcr.io/koysor/quant-finance/quant-finance:latest
    expose:
      - "8501"
    restart: unless-stopped
    mem_limit: 180m
    memswap_limit: 256m
    environment:
      - STREAMLIT_SERVER_HEADLESS=true
      - STREAMLIT_SERVER_BASE_URL_PATH=quant
      - MALLOC_ARENA_MAX=2
      - PYTHONOPTIMIZE=1
      - PYTHONDONTWRITEBYTECODE=1

  options:
    image: ghcr.io/koysor/quant-finance/options:latest
    expose:
      - "8501"
    restart: unless-stopped
    mem_limit: 180m
    memswap_limit: 256m
    environment:
      - STREAMLIT_SERVER_HEADLESS=true
      - STREAMLIT_SERVER_BASE_URL_PATH=options
      - MALLOC_ARENA_MAX=2
      - PYTHONOPTIMIZE=1
      - PYTHONDONTWRITEBYTECODE=1

  fixed-income:
    image: ghcr.io/koysor/quant-finance/fixed-income:latest
    expose:
      - "8501"
    restart: unless-stopped
    mem_limit: 180m
    memswap_limit: 256m
    environment:
      - STREAMLIT_SERVER_HEADLESS=true
      - STREAMLIT_SERVER_BASE_URL_PATH=fixed-income
      - MALLOC_ARENA_MAX=2
      - PYTHONOPTIMIZE=1
      - PYTHONDONTWRITEBYTECODE=1

  portfolio-management:
    image: ghcr.io/koysor/quant-finance/portfolio-management:latest
    expose:
      - "8501"
    restart: unless-stopped
    mem_limit: 180m
    memswap_limit: 256m
    environment:
      - STREAMLIT_SERVER_HEADLESS=true
      - STREAMLIT_SERVER_BASE_URL_PATH=portfolio
      - MALLOC_ARENA_MAX=2
      - PYTHONOPTIMIZE=1
      - PYTHONDONTWRITEBYTECODE=1

volumes:
  caddy_data:
    name: caddy_data
    external: true
  caddy_config:
